<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Logs de Tentativas de Trial Negadas - SmartManiaa</title>
  <style>
    /* Estilos da página */
    body { font-family: -apple-system, BlinkMacMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 2em; background-color: #f4f6f8; color: #333; }
    .container { max-width: 1100px; margin: 0 auto; background-color: #fff; padding: 2em; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-radius: 8px; }
    h1 { color: #2c3e50; }
    table { width: 100%; border-collapse: collapse; margin-top: 2em; }
    th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #ddd; }
    th { background-color: #e67e22; color: white; }
    .back-link { display: inline-block; margin-bottom: 2em; color: #3498db; text-decoration: none; }
    .action-btns { float: right; display: flex; gap: 10px; }
    .btn-action { color: white; padding: 8px 18px; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; }
    .export-btn { background-color: #27ae60; }
    .clear-btn { background-color: #e74c3c; }
    .notice { margin-bottom:15px;padding:10px 16px; background:#daf6e6;color:#207044; border-radius:4px; border:1px solid #b4e5cd; }
  </style>
  
  <script>
    function exportCsv() {
      // Lógica de exportação pode ser implementada se necessário, mas por enquanto o link direto para a rota de exportação é mais simples.
      window.location.href = '/admin/audit_log/export.csv?event_type=trial_denied';
    }
  </script>
</head>
<body>
  <div class="container">
    <a href="/admin" class="back-link">&larr; Voltar ao Painel Principal</a>

    <% if session[:notice] %>
      <div class="notice"><%= session.delete(:notice) %></div>
    <% end %>

    <h1>Detalhamento de Tentativas de Trial Negadas</h1>
    
    <div class="action-btns">
      <button class="btn-action export-btn" onclick="exportCsv()">Exportar para CSV</button>
      <form action="/admin/trials/clear" method="post" style="display:inline; margin:0;">
        <button type="submit" class="btn-action clear-btn" onclick="return confirm('Tem certeza que deseja apagar TODOS os registros de tentativas negadas?');">
          Limpar Registros
        </button>
      </form>
    </div>

    <div style="clear:both"></div>
    <p>Esta lista mostra todos os usuários que tentaram iniciar um trial mas foram bloqueados.</p>
    
    <table id="attempts-table">
      <thead>
        <tr>
          <th>Email</th>
          <th>MAC Address</th>
          <th>Produto Tentado</th>
          <th>Motivo da Falha</th>
          <th>Data</th>
        </tr>
      </thead>
      <tbody>
        <% if @attempts.num_tuples.zero? %>
          <tr>
            <td colspan="5" style="text-align: center;">Nenhuma tentativa de trial negada foi registrada.</td>
          </tr>
        <% else %>
          <% @attempts.each do |attempt| %>
            <% details = JSON.parse(attempt['details'] || '{}') %>
            <tr>
              <td><%= attempt['email'] %></td>
              <td><%= details['mac_address'] %></td>
              <td><%= details['product_sku'] %></td>
              <td><%= details['reason'] %></td>
              <td><%= Time.parse(attempt['recorded_at']).strftime('%d/%m/%Y %H:%M') %></td>
            </tr>
          <% end %>
        <% end %>
      </tbody>
    </table>
  </div>
</body>
</html>