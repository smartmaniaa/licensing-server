<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Detalhes da Licença - SmartManiaa</title>
  <style>
    /* Estilos completos para a página */
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 2em; background-color: #f4f6f8; color: #333; }
    .container { max-width: 900px; margin: 0 auto; background-color: #fff; padding: 2em; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-radius: 8px; }
    h1, h2 { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
    ul { list-style-type: none; padding: 0; }
    li { background-color: #f9f9f9; padding: 10px; border: 1px solid #ddd; margin-bottom: 10px; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; }
    table { width: 100%; border-collapse: collapse; margin-top: 1em; }
    th, td { padding: 10px 12px; text-align: left; border-bottom: 1px solid #ddd; }
    th { background-color: #ecf0f1; color: #34495e; }
    .back-link { display: inline-block; margin-bottom: 2em; color: #3498db; text-decoration: none; }
    .back-link:hover { text-decoration: underline; }
    .actions-box { margin-top: 2em; padding: 1.5em; border: 1px solid #ddd; border-radius: 8px; }
    .actions-box form { display: inline-block; margin-right: 1em; }
    .actions-box button { background-color: #c0392b; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; font-size: 14px; }
    .actions-box button.unlink { background-color: #f39c12; }
    .status-active { color: #27ae60; font-weight: bold; }
    .status-trial { color: #2980b9; font-weight: bold; }
    .status-revoked { color: #c0392b; font-weight: bold; }
    .status-suspended { color: #e67e22; font-weight: bold; }
    .btn-delete { background-color: #e74c3c; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px; }
  </style>
</head>
<body>
  <div class="container">
    <a href="/admin" class="back-link">&larr; Voltar para a lista</a>
    <h1>Detalhes da Licença</h1>
    <% if @license %>
      <h2>Informações Principais (Chaveiro)</h2>
      <ul>
        <li><strong>ID da Licença:</strong> <span><%= @license['id'] %></span></li>
        <li><strong>Email:</strong> <span><%= @license['email'] %></span></li>
        <li><strong>Chave:</strong> <code><%= @license['license_key'] %></code></li>
        <li><strong>Família:</strong> <span><%= @license['family'] %></span></li>
        <li><strong>MAC Address Vinculado:</strong> <span><%= @license['mac_address'] || 'Nenhum' %></span></li>
      </ul>

      <h2>Direitos de Uso (Entitlements)</h2>
      <table>
        <thead>
          <tr>
            <th>Produto</th>
            <th>Status</th>
            <th>Origem</th>
            <th>Validade</th>
            <th>ID Assinatura Stripe</th>
            <th style="width: 80px;">Ações</th>
          </tr>
        </thead>
        <tbody>
          <% if @entitlements.num_tuples.zero? %>
            <tr>
              <td colspan="6" style="text-align: center;">Nenhum direito de uso encontrado para esta licença.</td>
            </tr>
          <% else %>
            <% @entitlements.each do |entitlement| %>
              <tr>
                <td><%= entitlement['product_name'] %></td>
                <td><span class="status-<%= entitlement['status'] %>"><%= entitlement['status'].capitalize %></span></td>
                <td><%= entitlement['origin'] %></td>
                <td>
                  <% if entitlement['trial_expires_at'] %>
                    Trial até <%= Time.parse(entitlement['trial_expires_at']).strftime('%d/%m/%Y %H:%M') %>
                  <% elsif entitlement['expires_at'] %>
                    Expira em <%= Time.parse(entitlement['expires_at']).strftime('%d/%m/%Y %H:%M') %>
                  <% else %>
                    Vitalícia
                  <% end %>
                </td>
                <td><code><%= entitlement['platform_subscription_id'] || 'N/A' %></code></td>
                <td>
                  <form action="/admin/entitlement/<%= entitlement['id'] %>/delete" method="post" onsubmit="return confirm('Tem certeza que deseja DELETAR este direito de uso permanentemente?');">
                    <input type="hidden" name="license_id" value="<%= @license['id'] %>">
                    <button type="submit" class="btn-delete">Deletar</button>
                  </form>
                </td>
              </tr>
            <% end %>
          <% end %>
        </tbody>
      </table>
      
      <div class="actions-box">
        <h2>Ações da Licença Inteira</h2>
        <form action="/admin/license/<%= @license['id'] %>/unlink_mac" method="post" onsubmit="return confirm('Tem certeza que deseja desvincular esta licença da máquina atual?');">
          <button type="submit" class="unlink">Desvincular Máquina</button>
        </form>
        <form action="/admin/license/<%= @license['id'] %>/revoke" method="post" onsubmit="return confirm('ATENÇÃO: Isso irá REVOGAR TODOS os direitos de uso ATIVOS desta licença. Confirma?');">
          <button type="submit">Revogar Todos Direitos</button>
        </form>
         <form action="/admin/license/<%= @license['id'] %>/delete" method="post" onsubmit="return confirm('CUIDADO: Isso irá APAGAR PERMANENTEMENTE a licença e todos os seus direitos de uso. Deseja continuar?');">
          <button type="submit" style="background-color: #e74c3c;">Deletar Licença</button>
        </form>
      </div>
      <% else %>
      <p>Licença não encontrada.</p>
    <% end %>
  </div>
</body>
</html>