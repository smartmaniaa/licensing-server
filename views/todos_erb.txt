admin_dashboard.erb

<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Painel de Controle - SmartManiaa</title>
  <style>
    /* Estilos completos da página */
    body { font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif; margin:2em; background:#f4f6f8; color:#333;}
    h1 { color: #2c3e50; }
    .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #3498db; padding-bottom: 10px; margin-bottom: 1em;}
    .header-buttons { display: flex; gap: 1em; }
    .btn { background: #3498db; color: #fff; padding: 10px 18px; border: none; border-radius: 5px; text-decoration: none; font-weight: 500; font-size: 15px; }
    .btn-secondary { background-color: #7f8c8d; } /* Cor para o botão de exportar */
    table { width: 100%; border-collapse: collapse; margin-top: 1em; background-color: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.1);}
    th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #ddd;}
    th { background-color: #3498db; color: white;}
    tr:hover { background-color: #e8f4fd;}
    a { color: #3498db; text-decoration: none;}
    a:hover { text-decoration: underline;}
    .status-ativo { color: #27ae60; font-weight: bold; }
    .status-inativo { color: #7f8c8d; }
  </style>
</head>
<body>
  <div class="header">
    <h1>Painel de Controle SmartManiaa</h1>
    <div class="header-buttons">
      <a href="/admin/products" class="btn">Gerenciar Produtos</a>
      <a href="/admin/new" class="btn">Nova Licença</a>
      <a href="/admin/families" class="btn">Centro de Controle</a>
      <a href="/admin/trials" class="btn">Tentativas de Trial</a>
      <a href="/admin/licenses/export.csv" class="btn btn-secondary">Exportar CSV</a>
    </div>
  </div>

  <p>Abaixo está a lista de todas as licenças (chaveiros) criadas. Clique em uma chave para ver os detalhes e os direitos de uso associados.</p>

  <table>
    <thead>
      <tr>
        <th>Email</th>
        <th>Chave de Licença</th>
        <th>Status</th>
        <th>Origem (Ativas)</th>
        <th>Data de Criação</th>
      </tr>
    </thead>
    <tbody>
      <% if @licenses.num_tuples.zero? %>
        <tr>
          <td colspan="5" style="text-align: center;">Nenhuma licença encontrada.</td>
        </tr>
      <% else %>
        <% @licenses.each do |license| %>
          <tr>
            <td><%= license['email'] %></td>
            <td><a href="/admin/license/<%= license['id'] %>"><code><%= license['license_key'] %></code></a></td>
            <td>
              <span class="status-<%= license['summary_status'].downcase %>">
                <%= license['summary_status'] %>
              </span>
            </td>
            <td>
              <%= license['summary_origins'] %>
            </td>
            <td><%= Time.parse(license['created_at']).strftime('%d/%m/%Y %H:%M') %></td>
          </tr>
        <% end %>
      <% end %>
    </tbody>
  </table>
</body>
</html>


admin_new_product.erb

<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Adicionar Novo Produto - SmartManiaa</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 2em; background-color: #f4f6f8; color: #333; }
    .container { max-width: 800px; margin: 0 auto; background-color: #fff; padding: 2em; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-radius: 8px; }
    h1 { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
    .form-group { margin-bottom: 1.5em; }
    label { display: block; margin-bottom: 0.5em; font-weight: bold; }
    input[type="text"] { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
    button { background-color: #28a745; color: white; border: none; padding: 12px 20px; border-radius: 5px; cursor: pointer; font-size: 16px; }
    button:hover { opacity: 0.9; }
    .back-link { display: inline-block; margin-bottom: 2em; color: #3498db; text-decoration: none; }
    .back-link:hover { text-decoration: underline; }
    .error-box { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; padding: 1em; margin-bottom: 1.5em; border-radius: 5px; }
  </style>
</head>
<body>
  <div class="container">
    <a href="/admin/products" class="back-link">&larr; Voltar para a lista de produtos</a>
    <h1>Adicionar Novo Produto</h1>

    <% if @error %>
      <div class="error-box">
        <%= @error %>
      </div>
    <% end %>

    <form action="/admin/products" method="post">
      <div class="form-group">
        <label for="sku">SKU do Produto (ID Interno Único, ex: smartgrid_axis)</label>
        <input type="text" id="sku" name="sku" required>
      </div>
      <div class="form-group">
        <label for="name">Nome do Produto (Ex: SmartGrid Axis)</label>
        <input type="text" id="name" name="name" required>
      </div>
      <div class="form-group">
        <label for="family">Família (Ex: smartgrid, smartfield)</label>
        <input type="text" id="family" name="family" required>
      </div>
      <hr style="margin: 2em 0;">
      <h4>Informações da Plataforma (Stripe)</h4>
      <div class="form-group">
        <label for="platform_id">ID de Preço do Stripe (Ex: price_test_...)</label>
        <input type="text" id="platform_id" name="platform_id" required>
      </div>
      <div class="form-group">
        <label for="purchase_link">Link de Compra (Ex: https://buy.stripe.com/...)</label>
        <input type="text" id="purchase_link" name="purchase_link">
      </div>

      <button type="submit">Adicionar Produto</button>
    </form>
  </div>
</body>
</html>


admin_families.erb

<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Centro de Controle - SmartManiaa</title>
  <style>
    body { font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif; margin:2em; background:#f4f6f8; color:#333;}
    .container { max-width: 900px; margin: 0 auto; background-color: #fff; padding: 2em; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-radius: 8px; }
    h1 { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
    .back-link { display: inline-block; margin-bottom: 2em; color: #3498db; text-decoration: none; }
    .family-list a { display: block; background-color: #f9f9f9; padding: 15px; margin-bottom: 10px; border-radius: 5px; text-decoration: none; color: #2c3e50; font-weight: 500; font-size: 1.1em; transition: background-color 0.2s; }
    .family-list a:hover { background-color: #e8f4fd; }
  </style>
</head>
<body>
  <div class="container">
    <a href="/admin" class="back-link">&larr; Voltar ao Painel Principal</a>
    <h1>Centro de Controle da Família</h1>
    <p>Selecione uma família de produtos abaixo para gerenciar suas configurações de e-mail, URLs e outras variáveis personalizadas.</p>

    <div class="family-list">
      <% @families.each do |family| %>
        <a href="/admin/family/<%= family['family_name'] %>">
          <%= family['display_name'] || family['family_name'].capitalize %>
        </a>
      <% end %>
    </div>
  </div>
</body>
</html>

license_detail.erb

<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Detalhes da Licença - SmartManiaa</title>
  <style>
    /* Estilos completos para a página */
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 2em; background-color: #f4f6f8; color: #333; }
    .container { max-width: 900px; margin: 0 auto; background-color: #fff; padding: 2em; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-radius: 8px; }
    h1, h2 { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
    ul { list-style-type: none; padding: 0; }
    li { background-color: #f9f9f9; padding: 10px; border: 1px solid #ddd; margin-bottom: 10px; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; }
    table { width: 100%; border-collapse: collapse; margin-top: 1em; }
    th, td { padding: 10px 12px; text-align: left; border-bottom: 1px solid #ddd; }
    th { background-color: #ecf0f1; color: #34495e; }
    .back-link { display: inline-block; margin-bottom: 2em; color: #3498db; text-decoration: none; }
    .back-link:hover { text-decoration: underline; }
    .actions-box { margin-top: 2em; padding: 1.5em; border: 1px solid #ddd; border-radius: 8px; }
    .actions-box form { display: inline-block; margin-right: 1em; }
    .actions-box button { background-color: #c0392b; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; font-size: 14px; }
    .actions-box button.unlink { background-color: #f39c12; }
    .status-active { color: #27ae60; font-weight: bold; }
    .status-trial { color: #2980b9; font-weight: bold; }
    .status-revoked { color: #c0392b; font-weight: bold; }
    .status-suspended { color: #e67e22; font-weight: bold; }
    .btn-delete { background-color: #e74c3c; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px; }
  </style>
</head>
<body>
  <div class="container">
    <a href="/admin" class="back-link">&larr; Voltar para a lista</a>
    <h1>Detalhes da Licença</h1>
    <% if @license %>
      <h2>Informações Principais (Chaveiro)</h2>
      <ul>
        <li><strong>ID da Licença:</strong> <span><%= @license['id'] %></span></li>
        <li><strong>Email:</strong> <span><%= @license['email'] %></span></li>
        <li><strong>Chave:</strong> <code><%= @license['license_key'] %></code></li>
        <li><strong>Família:</strong> <span><%= @license['family'] %></span></li>
        <li><strong>MAC Address Vinculado:</strong> <span><%= @license['mac_address'] || 'Nenhum' %></span></li>
      </ul>

      <h2>Direitos de Uso (Entitlements)</h2>
      <table>
        <thead>
          <tr>
            <th>Produto</th>
            <th>Status</th>
            <th>Origem</th>
            <th>Validade</th>
            <th>ID Assinatura Stripe</th>
            <th style="width: 80px;">Ações</th>
          </tr>
        </thead>
        <tbody>
          <% if @entitlements.num_tuples.zero? %>
            <tr>
              <td colspan="6" style="text-align: center;">Nenhum direito de uso encontrado para esta licença.</td>
            </tr>
          <% else %>
            <% @entitlements.each do |entitlement| %>
              <tr>
                <td><%= entitlement['product_name'] %></td>
                <td><span class="status-<%= entitlement['status'] %>"><%= entitlement['status'].capitalize %></span></td>
                <td><%= entitlement['origin'] %></td>
                <td>
                  <% if entitlement['trial_expires_at'] %>
                    Trial até <%= Time.parse(entitlement['trial_expires_at']).strftime('%d/%m/%Y %H:%M') %>
                  <% elsif entitlement['expires_at'] %>
                    Expira em <%= Time.parse(entitlement['expires_at']).strftime('%d/%m/%Y %H:%M') %>
                  <% else %>
                    Vitalícia
                  <% end %>
                </td>
                <td><code><%= entitlement['platform_subscription_id'] || 'N/A' %></code></td>
                <td>
                  <form action="/admin/entitlement/<%= entitlement['id'] %>/delete" method="post" onsubmit="return confirm('Tem certeza que deseja DELETAR este direito de uso permanentemente?');">
                    <input type="hidden" name="license_id" value="<%= @license['id'] %>">
                    <button type="submit" class="btn-delete">Deletar</button>
                  </form>
                </td>
              </tr>
            <% end %>
          <% end %>
        </tbody>
      </table>
      
      <div class="actions-box">
        <h2>Ações da Licença Inteira</h2>
        <form action="/admin/license/<%= @license['id'] %>/unlink_mac" method="post" onsubmit="return confirm('Tem certeza que deseja desvincular esta licença da máquina atual?');">
          <button type="submit" class="unlink">Desvincular Máquina</button>
        </form>
        <form action="/admin/license/<%= @license['id'] %>/revoke" method="post" onsubmit="return confirm('ATENÇÃO: Isso irá REVOGAR TODOS os direitos de uso ATIVOS desta licença. Confirma?');">
          <button type="submit">Revogar Todos Direitos</button>
        </form>
         <form action="/admin/license/<%= @license['id'] %>/delete" method="post" onsubmit="return confirm('CUIDADO: Isso irá APAGAR PERMANENTEMENTE a licença e todos os seus direitos de uso. Deseja continuar?');">
          <button type="submit" style="background-color: #e74c3c;">Deletar Licença</button>
        </form>
      </div>
      <% else %>
      <p>Licença não encontrada.</p>
    <% end %>
  </div>
</body>
</html>

admin_products.erb

<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Gerenciar Produtos - SmartManiaa</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 2em; background-color: #f4f6f8; color: #333; }
    .container { max-width: 1000px; margin: 0 auto; background-color: #fff; padding: 2em; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-radius: 8px; }
    h1 { color: #2c3e50; }
    .header { display: flex; justify-content: space-between; align-items: center; }
    table { width: 100%; border-collapse: collapse; margin-top: 2em; }
    th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #ddd; word-break: break-all; }
    th { background-color: #3498db; color: white; }
    tr:nth-child(even) { background-color: #f2f2f2; }
    .back-link { display: inline-block; margin-bottom: 2em; color: #3498db; text-decoration: none; }
    .back-link:hover { text-decoration: underline; }
    .btn { background-color: #28a745; color: white; padding: 10px 15px; text-decoration: none; border-radius: 5px; font-size: 14px; }
    .btn-edit { background-color: #f39c12; }
    .btn:hover { opacity: 0.9; }
    .actions { display: flex; gap: 0.5em; }
    .actions form { margin: 0; }
    .btn-delete { background-color: #dc3545; border: none; cursor: pointer; color: white; padding: 5px 10px; border-radius: 5px; font-size: 14px; }
  </style>
</head>
<body>
  <div class="container">
    <a href="/admin" class="back-link">&larr; Voltar ao Painel Principal</a>
    <div class="header">
      <h1>Gerenciar Produtos</h1>
      <a href="/admin/products/new" class="btn">Adicionar Novo Produto</a>
    </div>
    <p>Aqui você pode editar os detalhes de cada produto e definir quais produtos compõem uma suite.</p>

    <table>
      <thead>
        <tr>
          <th>Nome do Produto</th>
          <th>SKU (ID Interno)</th>
          <th>Família</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody>
        <% if @products.num_tuples.zero? %>
          <tr>
            <td colspan="4" style="text-align: center;">Nenhum produto encontrado.</td>
          </tr>
        <% else %>
          <% @products.each do |product| %>
            <tr>
              <td><%= product['name'] %></td>
              <td><code><%= product['sku'] %></code></td>
              <td><%= product['family'] %></td>
              <td class="actions">
                <a href="/admin/product/<%= product['sku'] %>/edit" class="btn btn-edit">Editar</a>
                <form action="/admin/product/<%= product['sku'] %>/delete" method="post" onsubmit="return confirm('Tem certeza que deseja excluir este produto?');">
                  <button type="submit" class="btn-delete">Excluir</button>
                </form>
              </td>
            </tr>
          <% end %>
        <% end %>
      </tbody>
    </table>
  </div>
</body>
</html>


admin_trial_attemps.erb

<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Tentativas de Trial Negadas - SmartManiaa</title>
  <style>
    /* Estilos da página */
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 2em; background-color: #f4f6f8; color: #333; }
    .container { max-width: 1100px; margin: 0 auto; background-color: #fff; padding: 2em; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-radius: 8px; }
    h1 { color: #2c3e50; }
    table { width: 100%; border-collapse: collapse; margin-top: 2em; }
    th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #ddd; }
    th { background-color: #e67e22; color: white; }
    .back-link { display: inline-block; margin-bottom: 2em; color: #3498db; text-decoration: none; }
    .action-btns { float: right; display: flex; gap: 10px; }
    .btn-action { color: white; padding: 8px 18px; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; }
    .export-btn { background-color: #27ae60; }
    .clear-btn { background-color: #e74c3c; }
    .notice { margin-bottom:15px;padding:10px 16px; background:#daf6e6;color:#207044; border-radius:4px; border:1px solid #b4e5cd; }
  </style>
  
  <script>
    function exportCsv() {
      let rows = Array.from(document.querySelectorAll("#attempts-table tbody tr"));
      if (rows.length === 0 || (rows.length === 1 && rows[0].querySelector("td[colspan]"))) {
        alert("Não há dados para exportar.");
        return;
      }
      let csvContent = "data:text/csv;charset=utf-8," +
        "Email,MAC Address,Produto Tentado,Motivo da Falha,Data\n" +
        rows.map(row =>
          Array.from(row.querySelectorAll('td')).map(td => `"${td.innerText.replace(/"/g, '""')}"`).join(',')
        ).join('\n');
      
      var encodedUri = encodeURI(csvContent);
      var link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", "tentativas_trial_negadas.csv");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
  </script>
</head>
<body>
  <div class="container">
    <a href="/admin" class="back-link">&larr; Voltar ao Painel Principal</a>

    <% if session[:notice] %>
      <div class="notice"><%= session.delete(:notice) %></div>
    <% end %>

    <h1>Detalhamento de Tentativas de Trial Negadas</h1>
    
    <div class="action-btns">
      <button class="btn-action export-btn" onclick="exportCsv()">Exportar para CSV</button>
      <form action="/admin/trials/clear" method="post" style="display:inline; margin:0;">
        <button type="submit" class="btn-action clear-btn" onclick="return confirm('Tem certeza que deseja apagar TODOS os registros de tentativas negadas?');">
          Limpar Registros
        </button>
      </form>
    </div>

    <div style="clear:both"></div>
    <p>Esta lista mostra todos os usuários que tentaram iniciar um trial mas foram bloqueados.</p>
    
    <table id="attempts-table"> <thead>
        <tr>
          <th>Email</th>
          <th>MAC Address</th>
          <th>Produto Tentado</th>
          <th>Motivo da Falha</th>
          <th>Data</th>
        </tr>
      </thead>
      <tbody>
        <% if @attempts.num_tuples.zero? %>
          <tr>
            <td colspan="5" style="text-align: center;">Nenhuma tentativa de trial negada foi registrada.</td>
          </tr>
        <% else %>
          <% @attempts.each do |attempt| %>
            <tr>
              <td><%= attempt['email'] %></td>
              <td><%= attempt['mac_address'] %></td>
              <td><%= attempt['product_sku'] %></td>
              <td><%= attempt['reason'] %></td>
              <td><%= Time.parse(attempt['attempted_at']).strftime('%d/%m/%Y %H:%M') %></td>
            </tr>
          <% end %>
        <% end %>
      </tbody>
    </table>
  </div>
</body>
</html>

admin_new_license.erb

<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Criar Nova Licença - SmartManiaa</title>
   <style>
    /*-- Estilos (sem alterações, mantidos para consistência) --*/
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 2em; background-color: #f4f6f8; color: #333; }
    .container { max-width: 800px; margin: 0 auto; background-color: #fff; padding: 2em; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-radius: 8px; }
    h1 { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
    .form-group { margin-bottom: 1.5em; }
    label { display: block; margin-bottom: 0.5em; font-weight: bold; }
    input[type="email"], input[type="date"], select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
    .checkbox-group { display: flex; flex-wrap: wrap; gap: 10px 24px; }
    button { background-color: #28a745; color: white; border: none; padding: 12px 20px; border-radius: 5px; cursor: pointer; font-size: 16px; }
    .back-link { display: inline-block; margin-bottom: 2em; color: #3498db; text-decoration: none; }
  </style>

  <script>
    // Executa o nosso código apenas quando o HTML da página estiver totalmente carregado.
    document.addEventListener('DOMContentLoaded', function() {
      
      // Converte o JSON de produtos agrupados, enviado pelo backend, para um objeto JavaScript.
      // A tag <%= %> injeta a string JSON diretamente aqui.
      const productsByFamily = JSON.parse('<%= @products_by_family %>');

      const familySelector = document.getElementById('family_selector');
      const productsContainer = document.getElementById('products_container');

      // Adiciona um "ouvinte" que dispara a função sempre que o valor do seletor mudar.
      familySelector.addEventListener('change', function() {
        const selectedFamily = this.value;

        // 1. Limpa a lista de produtos anterior.
        productsContainer.innerHTML = '';

        // 2. Se uma família válida foi selecionada, popula com os novos produtos.
        if (selectedFamily && productsByFamily[selectedFamily]) {
          productsByFamily[selectedFamily].forEach(product => {
            const div = document.createElement('div');
            // Cria o HTML do checkbox e da label para cada produto.
            div.innerHTML = `
              <input type="checkbox" name="product_skus[]" value="${product.sku}" id="product_${product.sku}">
              <label for="product_${product.sku}">${product.name}</label>
            `;
            productsContainer.appendChild(div);
          });
        } else {
          // Se nenhuma família for selecionada, mostra a mensagem inicial.
          productsContainer.innerHTML = '<p><i>Selecione uma família acima para ver os produtos.</i></p>';
        }
      });
    });
  </script>
</head>
<body>
  <div class="container">
    <a href="/admin" class="back-link">&larr; Voltar para a lista</a>
    <h1>Criar Nova Licença Manualmente</h1>
    
    <form action="/admin/create" method="post" autocomplete="off">
      <div class="form-group">
        <label for="email">Email do Cliente</label>
        <input type="email" id="email" name="email" required autocomplete="off">
      </div>

      <div class="form-group">
        <label for="family_selector">1. Selecione a Família do Produto</label>
        <select id="family_selector">
          <option value="">-- Escolha uma família --</option>
          <% @families.each do |family| %>
            <option value="<%= family %>"><%= family.capitalize %></option>
          <% end %>
        </select>
      </div>
      
      <div class="form-group">
        <label>2. Produtos a Incluir (Direitos de Uso)</label>
        <div class="checkbox-group" id="products_container">
          <p><i>Selecione uma família acima para ver os produtos.</i></p>
        </div>
      </div>

      <div class="form-group">
        <label for="origin">Origem da Licença</label>
        <select id="origin" name="origin">
          <option value="manual">Manual</option>
          <option value="beta">Beta Tester</option>
          <option value="youtuber">Youtuber/Parceiro</option>
          <option value="suporte">Suporte</option>
        </select>
      </div>

      <div class="form-group">
        <label for="expires_at">Data de Expiração (deixe em branco para licença vitalícia)</label>
        <input type="date" id="expires_at" name="expires_at">
      </div>

      <button type="submit">Criar Licença e Direitos</button>
    </form>
  </div>
</body>
</html>


admin_family_settings.erb

<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Configurações: <%= @family_info['display_name'] %> - SmartManiaa</title>
  <style>
    /* ... (Estilos sem alteração) ... */
    body { font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif; margin:2em; background:#f4f6f8; color:#333;}
    .container { max-width: 900px; margin: 0 auto; background-color: #fff; padding: 2em; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-radius: 8px; }
    h1, h2 { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
    h2 { font-size: 1.4em; margin-top: 2em; border-bottom-style: solid; border-bottom-width: 1px; }
    .form-group { margin-bottom: 1.5em; }
    label { display: block; margin-bottom: 0.5em; font-weight: bold; }
    input[type="text"], input[type="email"] { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
    .help-text { font-size: 0.9em; color: #666; margin-top: 5px; }
    .btn-save { background-color: #28a745; color: white; border: none; padding: 12px 20px; border-radius: 5px; cursor: pointer; font-size: 16px; text-decoration: none; }
    .btn-secondary { background-color: #3498db; }
    .form-actions { display: flex; align-items: center; gap: 15px; margin-top: 2em; }
    .rules-table { width: 100%; border-collapse: collapse; margin-top: 1em; }
    .rules-table th, .rules-table td { padding: 12px; border: 1px solid #ddd; text-align: left; }
    .notifier-list { list-style-type: none; padding: 0; }
    .notifier-list li { display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid #eee; }
    .tabs { display: flex; border-bottom: 2px solid #3498db; margin-bottom: 2em; }
    .tab-link { padding: 10px 20px; cursor: pointer; margin-bottom: -2px; border-radius: 5px 5px 0 0; border: none; transition: background-color 0.2s; background-color: #f0f0f0; color: #666; }
    .tab-link.active { background-color: #3498db; color: white; font-weight: 500; }
    .tab-link:not(.active):hover { background-color: #e9ecef; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
  </style>
</head>
<body>
  <div class="container">
    <a href="/admin/families" class="back-link">&larr; Voltar para a Lista de Famílias</a>
    <h1>Configurações da Família: <%= @family_info['display_name'] %></h1>

    <div class="tabs">
      <div class="tab-link active" onclick="openTab(event, 'Settings')">Configurações Gerais</div>
      <div class="tab-link" onclick="openTab(event, 'Reports')">Relatórios Financeiros</div>
    </div>

    <div id="Settings" class="tab-content active">
      <form action="/admin/family/<%= @family_name %>" method="post">
        <h2>Informações Gerais</h2>
        <div class="form-group">
          <label for="display_name">Nome de Exibição</label>
          <input type="text" id="display_name" name="display_name" value="<%= @family_info['display_name'] %>">
          <p class="help-text">Como a família aparecerá nos e-mails (Ex: SmartGrid Suite). Variável: {{product_family}}</p>
        </div>
        <div class="form-group">
          <label for="homepage_url">URL da Página da Família</label>
          <input type="text" id="homepage_url" name="homepage_url" value="<%= @family_info['homepage_url'] %>">
          <p class="help-text">Link principal para esta família. Variável: {{family_homepage_url}}</p>
        </div>
        <div class="form-group">
          <label for="support_email">E-mail de Suporte</label>
          <input type="email" id="support_email" name="support_email" value="<%= @family_info['support_email'] %>">
          <p class="help-text">E-mail de contato para esta família. Variável: {{family_support_email}}</p>
        </div>
        <div class="form-group">
          <label for="logo_url">URL do Logo</label>
          <input type="text" id="logo_url" name="logo_url" value="<%= @family_info['logo_url'] %>">
          <p class="help-text">URL da imagem do logo para esta família. Variável: {{family_logo_url}}</p>
        </div>
        <div class="form-group">
          <label for="sender_name">Nome do Remetente do E-mail</label>
          <input type="text" id="sender_name" name="sender_name" value="<%= @family_info['sender_name'] %>">
          <p class="help-text">O nome que aparecerá no campo "De:" do e-mail (Ex: Equipe SmartGrid). Não é uma variável de corpo.</p>
        </div>

        <h2>Notificações para Admins</h2>
        <ul class="notifier-list">
          <% @notifiers.each do |notifier| %>
            <li>
              <span><%= notifier['email'] %></span>
              <label><input type="checkbox" name="remove_notifiers[]" value="<%= notifier['email'] %>"> Remover</label>
            </li>
          <% end %>
        </ul>
        <div class="form-group">
          <label for="new_notifier_email">Adicionar Novo E-mail de Notificação</label>
          <input type="email" id="new_notifier_email" name="new_notifier_email" placeholder="novo.admin@email.com">
        </div>

        <h2>E-mails Automáticos para Clientes</h2>
        <table class="rules-table">
          <tbody>
            <% @templates.each do |template| %>
              <tr>
                <td>
                  <strong><%= template['name'] %></strong>
                  <small>(Gatilho: <%= template['trigger_event'] %>)</small>
                  <a href="/admin/email_templates/<%= template['id'] %>/edit">[Editar Conteúdo]</a>
                </td>
                <td style="width: 120px; text-align: center;">
                  <input type="checkbox" name="rules[<%= template['id'] %>]" <%= 'checked' if @rules[template['id']] %>>
                  <label>Ativo</label>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
        
        <div class="form-actions">
          <button type="submit" class="btn-save">Salvar Todas as Configurações</button>
          <a href="/admin/email_templates/new" class="btn-save btn-secondary">Criar Novo Template de E-mail</a>
        </div>
      </form>
    </div>

    <div id="Reports" class="tab-content">
      <h2>Relatórios Financeiros para <%= @family_info['display_name'] %></h2>
      <p><em>(Em desenvolvimento)</em></p>
      <p>Esta área exibirá os relatórios de vendas e repasses (payouts) filtrados especificamente para esta família de produtos.</p>
    </div>
  </div>

  <script>
    function openTab(evt, tabName) {
      var i, tabcontent, tablinks;
      tabcontent = document.getElementsByClassName("tab-content");
      for (i = 0; i < tabcontent.length; i++) {
        tabcontent[i].style.display = "none";
        tabcontent[i].className = tabcontent[i].className.replace(" active", "");
      }
      tablinks = document.getElementsByClassName("tab-link");
      for (i = 0; i < tablinks.length; i++) {
        tablinks[i].className = tablinks[i].className.replace(" active", "");
      }
      document.getElementById(tabName).style.display = "block";
      document.getElementById(tabName).className += " active";
      evt.currentTarget.className += " active";
    }

    // Garante que a primeira aba esteja visível e ativa ao carregar a página
    document.addEventListener("DOMContentLoaded", function() {
        // Corrige um bug visual para garantir que a aba certa esteja visível
        document.querySelector('.tab-link.active').click();
    });
  </script>
</body>
</html>

admin_email_template_new.erb

<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Criar Novo Template de E-mail - SmartManiaa</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 2em; background-color: #f4f6f8; color: #333; }
    .container { max-width: 900px; margin: 0 auto; background-color: #fff; padding: 2em; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-radius: 8px; }
    h1 { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
    .back-link { display: inline-block; margin-bottom: 2em; color: #3498db; text-decoration: none; }
    .form-group { margin-bottom: 1.5em; }
    label { display: block; margin-bottom: 0.5em; font-weight: bold; }
    input[type="text"], select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
    textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; min-height: 300px; font-family: monospace; }
    button { background-color: #28a745; color: white; border: none; padding: 12px 20px; border-radius: 5px; cursor: pointer; font-size: 16px; }
    .help-text { font-size: 0.9em; color: #666; margin-top: 5px; }
  </style>
</head>
<body>
  <div class="container">
    <a href="/admin/families" class="back-link">&larr; Voltar para o Centro de Controle</a>
    <h1>Criar Novo Template de E-mail</h1>
    
    <form action="/admin/email_templates" method="post">
      <div class="form-group">
        <label for="name">Nome Interno do Template</label>
        <input type="text" id="name" name="name" placeholder="Ex: Lembrete de Trial Expirando" required>
        <p class="help-text">Este nome é apenas para sua organização interna.</p>
      </div>
      <div class="form-group">
        <label for="trigger_event">Gatilho (Evento do Sistema)</label>
        <select id="trigger_event" name="trigger_event">
            <optgroup label="Gatilhos Imediatos">
              <option value="trial_started">Trial Iniciado</option>
              <option value="subscription_started">Assinatura Iniciada</option>
              <option value="admin_grant_created">Licença Nova Criada pelo Admin</option>
              <option value="admin_grant_added">Direitos Adicionados pelo Admin</option>
              <option value="trial_denied">Trial Negado</option>
              <option value="payment_failed">Falha no Pagamento</option>
              <option value="subscription_cancellation_scheduled">Cancelamento Agendado</option>
              <option value="subscription_revoked">Assinatura Revogada</option>
            </optgroup>
            <optgroup label="Gatilhos Agendados (Via Tarefa Diária)">
              <option value="trial_ending_in_3_days">Trial Vencendo em 3 Dias</option>
              <option value="trial_expires_today">Trial Vence Hoje</option>
              <option value="trial_expired_3_days_ago">Trial Vencido (3 dias atrás)</option>
              <option value="trial_expired_7_days_ago">Trial Vencido (7 dias atrás)</option>
              <option value="subscription_revoked_7_days_ago">Pós-Cancelamento (7 dias)</option>
              <option value="subscription_revoked_30_days_ago">Pós-Cancelamento (30 dias)</option>
            </optgroup>
        </select>
        <p class="help-text">Escolha a ação do sistema que deve disparar este e-mail.</p>
      </div>
      <div class="form-group">
        <label for="subject">Assunto do E-mail</label>
        <input type="text" id="subject" name="subject" placeholder="Ex: Seu trial SmartManiaa termina em 3 dias!" required>
        <p class="help-text">Variáveis disponíveis: <code>{{product_family}}</code></p>
      </div>
      <div class="form-group">
        <label for="body">Corpo do E-mail (HTML)</label>
        <textarea id="body" name="body" required></textarea>
        <p class="help-text">
          <b>Variáveis Disponíveis:</b><br>
          <code>{{license_key}}</code>, <code>{{trial_end_date}}</code>, <code>{{product_family}}</code> (Nome de Exibição)<br>
          <code>{{family_homepage_url}}</code>, <code>{{family_support_email}}</code>, <code>{{family_logo_url}}</code><br>
          <code>{{family_purchase_links}}</code> (Lista de links de compra)
        </p>
      </div>
      <button type="submit">Criar Template</button>
    </form>
  </div>
</body>
</html>

admin_email_template_edit.erb

<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Editar Template de E-mail - SmartManiaa</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 2em; background-color: #f4f6f8; color: #333; }
    .container { max-width: 900px; margin: 0 auto; background-color: #fff; padding: 2em; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-radius: 8px; }
    h1 { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
    .back-link { display: inline-block; margin-bottom: 2em; color: #3498db; text-decoration: none; }
    .form-group { margin-bottom: 1.5em; }
    label { display: block; margin-bottom: 0.5em; font-weight: bold; }
    input[type="text"], select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; font-size: 1em; }
    textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; min-height: 300px; font-family: monospace; font-size: 1em; }
    button { background-color: #28a745; color: white; border: none; padding: 12px 20px; border-radius: 5px; cursor: pointer; font-size: 16px; }
    .help-text { font-size: 0.9em; color: #666; margin-top: 5px; }
  </style>
</head>
<body>
  <div class="container">
    <a href="/admin/families" class="back-link">&larr; Voltar para o Centro de Controle</a>
    <h1>Editar Template: <%= @template['name'] %></h1>
    
    <form action="/admin/email_templates/<%= @template['id'] %>" method="post">
      <div class="form-group">
        <label for="trigger_event">Gatilho (Evento do Sistema)</label>
        <select id="trigger_event" name="trigger_event">
            <optgroup label="Gatilhos Imediatos">
              <option value="trial_started" <%= 'selected' if @template['trigger_event'] == 'trial_started' %>>Trial Iniciado</option>
              <option value="subscription_started" <%= 'selected' if @template['trigger_event'] == 'subscription_started' %>>Assinatura Iniciada</option>
              <option value="admin_grant_created" <%= 'selected' if @template['trigger_event'] == 'admin_grant_created' %>>Licença Nova Criada pelo Admin</option>
              <option value="admin_grant_added" <%= 'selected' if @template['trigger_event'] == 'admin_grant_added' %>>Direitos Adicionados pelo Admin</option>              
              <option value="trial_denied" <%= 'selected' if @template['trigger_event'] == 'trial_denied' %>>Trial Negado</option>
              <option value="payment_failed" <%= 'selected' if @template['trigger_event'] == 'payment_failed' %>>Falha no Pagamento</option>
              <option value="subscription_cancellation_scheduled" <%= 'selected' if @template['trigger_event'] == 'subscription_cancellation_scheduled' %>>Cancelamento Agendado</option>
              <option value="subscription_revoked" <%= 'selected' if @template['trigger_event'] == 'subscription_revoked' %>>Assinatura Revogada</option>
            </optgroup>
            <optgroup label="Gatilhos Agendados (Via Tarefa Diária)">
              <option value="trial_ending_in_3_days" <%= 'selected' if @template['trigger_event'] == 'trial_ending_in_3_days' %>>Trial Vencendo em 3 Dias</option>
              <option value="trial_expires_today" <%= 'selected' if @template['trigger_event'] == 'trial_expires_today' %>>Trial Vence Hoje</option>
              <option value="trial_expired_3_days_ago" <%= 'selected' if @template['trigger_event'] == 'trial_expired_3_days_ago' %>>Trial Vencido (3 dias atrás)</option>
              <option value="trial_expired_7_days_ago" <%= 'selected' if @template['trigger_event'] == 'trial_expired_7_days_ago' %>>Trial Vencido (7 dias atrás)</option>
              <option value="subscription_revoked_7_days_ago" <%= 'selected' if @template['trigger_event'] == 'subscription_revoked_7_days_ago' %>>Pós-Cancelamento (7 dias)</option>
              <option value="subscription_revoked_30_days_ago" <%= 'selected' if @template['trigger_event'] == 'subscription_revoked_30_days_ago' %>>Pós-Cancelamento (30 dias)</option>
            </optgroup>
        </select>
      </div>
      <div class="form-group">
        <label for="subject">Assunto do E-mail</label>
        <input type="text" id="subject" name="subject" value="<%= @template['subject'] %>" required>
        <p class="help-text">Variáveis disponíveis: <code>{{product_family}}</code></p>
      </div>
      <div class="form-group">
        <label for="body">Corpo do E-mail (HTML)</label>
        <textarea id="body" name="body" required><%= @template['body'] %></textarea>
        <p class="help-text">
          <b>Variáveis Disponíveis:</b><br>
          <code>{{license_key}}</code>, <code>{{trial_end_date}}</code>, <code>{{product_family}}</code> (Nome de Exibição)<br>
          <code>{{family_homepage_url}}</code>, <code>{{family_support_email}}</code>, <code>{{family_logo_url}}</code><br>
          <code>{{family_purchase_links}}</code> (Lista de links de compra)
        </p>
      </div>
      <button type="submit">Salvar Alterações</button>
    </form>
  </div>
</body>
</html>

admin_edit_product.erb

<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Editar Produto - SmartManiaa</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 2em; background-color: #f4f6f8; color: #333; }
    .container { max-width: 800px; margin: 0 auto; background-color: #fff; padding: 2em; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-radius: 8px; }
    h1, h2, h4 { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
    h4 { border-bottom: 1px solid #ccc; }
    .form-group { margin-bottom: 1.5em; }
    label { display: block; margin-bottom: 0.5em; font-weight: bold; }
    input[type="text"] { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
    input[readonly] { background-color: #e9ecef; cursor: not-allowed; }
    .checkbox-group label { font-weight: normal; }
    button { background-color: #28a745; color: white; border: none; padding: 12px 20px; border-radius: 5px; cursor: pointer; font-size: 16px; }
    button:hover { opacity: 0.9; }
    .back-link { display: inline-block; margin-bottom: 2em; color: #3498db; text-decoration: none; }
    .back-link:hover { text-decoration: underline; }
    .error-box { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; padding: 1em; margin-bottom: 1.5em; border-radius: 5px; }
  </style>
</head>
<body>
  <div class="container">
    <a href="/admin/products" class="back-link">&larr; Voltar para a lista de produtos</a>
    <h1>Editar Produto: <%= @product['name'] %></h1>

    <% if @error %>
      <div class="error-box">
        <%= @error %>
      </div>
    <% end %>

    <form action="/admin/product/<%= @product['sku'] %>" method="post">
      <h2>Detalhes do Produto Interno</h2>
      <div class="form-group">
        <label for="sku">SKU do Produto (ID Interno - não pode ser alterado)</label>
        <input type="text" id="sku" name="sku" value="<%= @product['sku'] %>" readonly>
      </div>
      <div class="form-group">
        <label for="name">Nome do Produto</label>
        <input type="text" id="name" name="name" value="<%= @product['name'] %>" required>
      </div>
      <div class="form-group">
        <label for="family">Família do Produto</label>
        <input type="text" id="family" name="family" value="<%= @product['family'] %>" required>
      </div>

      <hr style="margin: 2em 0;">
      <h4>Informações da Plataforma (Stripe)</h4>
      <div class="form-group">
        <label for="platform_id">ID de Preço do Stripe</label>
        <input type="text" id="platform_id" name="platform_id" value="<%= @platform_product['platform_id'] %>">
      </div>
      <div class="form-group">
        <label for="purchase_link">Link de Compra</label>
        <input type="text" id="purchase_link" name="purchase_link" value="<%= @platform_product['purchase_link'] %>">
      </div>

      <h2>Componentes da Suite (se aplicável)</h2>
      <div class="form-group">
        <p>Selecione os produtos que fazem parte deste pacote/suite.</p>
        <div class="checkbox-group">
          <% @all_other_products.each do |component| %>
            <% is_checked = @suite_components.any? { |sc| sc['component_product_id'] == component['sku'] } %>
            <div>
              <input type="checkbox" name="component_skus[]" value="<%= component['sku'] %>" id="component_<%= component['sku'] %>" <%= 'checked' if is_checked %>>
              <label for="component_<%= component['sku'] %>"><%= component['name'] %></label>
            </div>
          <% end %>
        </div>
      </div>

      <button type="submit">Salvar Alterações</button>
    </form>
  </div>
</body>
</html>
